#include "typedefs.h"
#include <stdint.h>

typedef struct {
  uint32_t color_palette[256];
} PacmanRom;

internal const uint8_t rom_hwcolors[32];
internal const uint8_t rom_palette[256];

internal void decode_color_palette(PacmanRom *rom);

void pm_init_rom(PacmanRom *rom) { decode_color_palette(rom); }

/* decode the Pacman color palette into a palette texture, on the original
    hardware, color lookup happens in two steps, first through 256-entry
    palette which indirects into a 32-entry hardware-color palette
    (of which only 16 entries are used on the Pacman hardware)
*/
internal void decode_color_palette(PacmanRom *rom) {
  uint32_t hw_colors[32];
  for (int i = 0; i < 32; i++) {
    /*
        Each color ROM entry describes an RGB color in 1 byte:

        | 7| 6| 5| 4| 3| 2| 1| 0|
        |B1|B0|G2|G1|G0|R2|R1|R0|

        Intensities are: 0x97 + 0x47 + 0x21
     */
    uint8_t rgb = rom_hwcolors[i];
    uint8_t r = ((rgb >> 0) & 1) * 0x21 + ((rgb >> 1) & 1) * 0x47 +
                ((rgb >> 2) & 1) * 0x97;
    uint8_t g = ((rgb >> 3) & 1) * 0x21 + ((rgb >> 4) & 1) * 0x47 +
                ((rgb >> 5) & 1) * 0x97;
    uint8_t b = ((rgb >> 6) & 1) * 0x47 + ((rgb >> 7) & 1) * 0x97;
    hw_colors[i] = 0xFF000000 | (b << 16) | (g << 8) | r;
  }
  for (int i = 0; i < 256; i++) {
    rom->color_palette[i] = hw_colors[rom_palette[i] & 0xF];
    // first color in each color block is transparent
    if ((i & 3) == 0) {
      rom->color_palette[i] &= 0x00FFFFFF;
    }
  }
}

internal const uint8_t rom_hwcolors[32] = {
    0x0,  0x7,  0x66, 0xef, 0x0,  0xf8, 0xea, 0x6f, 0x0, 0x3f, 0x0,
    0xc9, 0x38, 0xaa, 0xaf, 0xf6, 0x0,  0x0,  0x0,  0x0, 0x0,  0x0,
    0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0, 0x0,
};

internal const uint8_t rom_palette[256] = {
    0x0, 0x0, 0x0, 0x0, 0x0, 0xf, 0xb, 0x1, 0x0, 0x0, 0x0, 0x0, 0x0, 0xf, 0xb,
    0x3, 0x0, 0x0, 0x0, 0x0, 0x0, 0xf, 0xb, 0x5, 0x0, 0x0, 0x0, 0x0, 0x0, 0xf,
    0xb, 0x7, 0x0, 0x0, 0x0, 0x0, 0x0, 0xb, 0x1, 0x9, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xf, 0x0, 0xe,
    0x0, 0x1, 0xc, 0xf, 0x0, 0xe, 0x0, 0xb, 0x0, 0xc, 0xb, 0xe, 0x0, 0xc, 0xf,
    0x1, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1, 0x2, 0xf, 0x0, 0x7, 0xc, 0x2, 0x0, 0x9,
    0x6, 0xf, 0x0, 0xd, 0xc, 0xf, 0x0, 0x5, 0x3, 0x9, 0x0, 0xf, 0xb, 0x0, 0x0,
    0xe, 0x0, 0xb, 0x0, 0xe, 0x0, 0xb, 0x0, 0x0, 0x0, 0x0, 0x0, 0xf, 0xe, 0x1,
    0x0, 0xf, 0xb, 0xe, 0x0, 0xe, 0x0, 0xf, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0,
};
